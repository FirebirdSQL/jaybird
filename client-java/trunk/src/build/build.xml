<?xml version="1.0"?>

<!-- ======================================================================= -->
<!-- JDBC-JCA Driver for Firebird build file                                -->
<!-- ======================================================================= -->


<project name="FirebirdSQL" default="rar" basedir="../..">

    <property name="Name" value="FirebirdSQL"/>
    <property name="name" value="firebirdsql"/>
    <property name="version" value="0.0"/>

    <property name="lib.dir" value="${basedir}/lib"/>
    <property name="src.dir" value="${basedir}/src"/>

    <property name="src.resources" value="${src.dir}/resources"/>
    <property name="src.lib" value="${src.dir}/lib"/>

    <!--property name="build.dir" value="${basedir}/build"/>
    <property name="build.bin.dir" value="${build.dir}/bin"/>
    <property name="build.lib.dir" value="${build.dir}/lib"/>
    <property name="build.classes" value="${build.dir}/classes"/>
    <property name="build.docs.dir" value="${build.dir}/docs"/>
    <property name="build.javadocs.dir" value="${build.dir}/docs/api"/>
    <property name="build.jar-ra.dir" value="${build.dir}/jar"/>
    <property name="dist.dir" value="dist"/>
    <property name="external.dir" value="${dist.dir}/external"/>
    <property name="db.dir" value="${basedir}/db"/>
    <property name="dbsrc.dir" value="${basedir}/dbsrc"/-->
<!--you will presumably need to change this if you want to use it.-->
    <property name="jboss.base.dir" value="/usr/java/jboss/co4/jboss-all/build/output/jboss-3.0.0alpha"/>

    <!-- Setup the module environment. -->
    <property name="module.root" value="${basedir}"/>

    <property file="${module.root}/local.properties"/>
    <property name="module.source" value="${module.root}/src"/>
    <property name="module.output" value="${module.root}/output"/>
    <property name="module.tools" value="${module.root}/lib"/>
    <!--property name="module.thirdparty" value="${module.root}/thirdparty"/-->

    <!-- Where build generated files will go -->
    <property name="build.classes" value="${module.output}/classes"/>
    <property name="build.lib" value="${module.output}/lib"/>
    <property name="build.api" value="${module.output}/api"/>
    <property name="build.etc" value="${module.output}/etc"/>
    <property name="build.bin" value="${module.output}/bin"/>
    <property name="build.docs" value="${module.output}/docs"/>
    <property name="build.resources" value="${module.output}/resources"/>
    <property name="build.stylesheets" value="${module.output}/stylesheets"/>
    <property name="build.reports" value="${module.output}/reports"/>
    <property name="build.testlog" value="${module.output}/log"/>

    <property name="junit.timeout" value="600000"/> <!-- 10 minutes -->
    <property name="junit.batchtest.todir" value="${build.reports}"/>
    <property name="junit.jvm.options" value="-Ddummy"/>

    <property name="junit.formatter.type" value="xml"/>
    <property name="junit.formatter.usefile" value="true"/>
    <property name="junit.printsummary" value="true"/> 
    <property name="junit.haltonerror"  value="true"/>
    <property name="junit.haltonfailure"  value="true"/>
    <property name="junit.fork" value="true"/>
    <property name="junit.timeout" value="60000"/>
    <!--property name="junit.jvm" value="true"/-->

    <property name="test.db.dir" value="${module.output}/db"/>


    <property name="packages" value="org.firebirdsql.*"/>

    <property name="build.compiler" value="classic"/>

    <!--available property="jdk1.3+" classname="java.lang.StrictMath" /-->

    <path id="javac.classpath">
      <pathelement location="${build.classes}"/>
      <pathelement location="${src.lib}/jta-spec1_0_1.jar"/>
      <pathelement location="${src.lib}/connector.jar"/>
      <pathelement location="${src.lib}/jdbc-3_0-pfd2-classes.zip"/>
      <pathelement location="${src.lib}/jaas.jar"/>
      <pathelement location="${src.lib}/jmxri.jar"/>
      <pathelement location="${src.lib}/concurrent.jar"/>
      <pathelement location="${lib.dir}/junit.jar"/>
    </path>


  <!-- =================================================================== -->
  <!-- Fix cr-lf                                                           -->
  <!-- =================================================================== -->
  <target name="pretty">
    <fixcrlf srcDir="${src.dir}"
       includes="**/*.java,**/*.xml,**/*.sh"
       cr="remove"
       tab="remove"
       tablength="4"
       eof="remove"/>
  </target>


  <!-- =================================================================== -->
  <!-- Compiles the source code                                            -->
  <!-- =================================================================== -->
  <target name="compile" depends="compile-classes, compile-resources"/>

  <target name="compile-classes" >
    <mkdir dir="${build.classes}"/>
    <depend srcDir="${src.dir}"
           destDir="${build.classes}"
           cache="${build.classes}"/>

    <javac srcdir="${src.dir}"
           destdir="${build.classes}"
           target="1.2"
           debug="on"
           deprecation="on"
           optimize="on"
           includes="org/**"
           excludes="**/temp*"
    >
      <classpath refid="javac.classpath"/>
    </javac>
  </target>

  <!-- Compile resource files -->
  <target name="compile-resources">
    <mkdir dir="${build.resources}"/>
    <copy todir="${build.resources}" filtering="no">
      <fileset dir="${src.resources}">
         <include name="**/*"/>
      </fileset>
    </copy>
  </target>

  <!-- =================================================================== -->
  <!-- Creates the jar archives                                            -->
  <!-- =================================================================== -->
  <target name="jars" depends="jar-jmx, rar"/>

  <target name="jar-ra" depends="compile">

    <mkdir dir="${build.lib}"/>
    <jar jarfile="${build.lib}/firebirdsql.jar">
       <fileset dir="${build.classes}">
         <include name="org/firebirdsql/**"/>
         <exclude name="**/Test*.java"/>
       </fileset>
       <fileset dir="${build.resources}">
         <include name="*.properties"/>
       </fileset>
    </jar>
  </target>


  <!-- =================================================================== -->
  <!-- Creates the jmx-jar archives                                            -->
  <!-- =================================================================== -->
  <target name="jar-jmx" depends="compile">

    <mkdir dir="${build.lib}"/>
    <jar jarfile="${build.lib}/firebirdjmx.jar">
       <fileset dir="${build.classes}">
         <include name="org/firebirdsql/**"/>
         <exclude name="**/Test*.java"/>
         <exclude name="**/jca/**"/>
         <exclude name="**/jdbc/**"/>
       </fileset>
       <fileset dir="${build.resources}">
         <include name="*.properties"/>
       </fileset>
    </jar>
  </target>



  <!-- =================================================================== -->
  <!-- Creates the rar archives                                            -->
  <!-- =================================================================== -->
  <target name="rar" depends="jar-ra">
    <!--mkdir dir="${build.jar-ra.dir}/META-INF"/>
    <copy todir="${build.jar-ra.dir}/META-INF">
        <fileset dir="${src.resources.dir}"/>
    </copy-->

    <jar jarfile="${build.lib}/firebirdsql.rar">
      <fileset dir="${build.lib}">
        <include name="firebirdsql.jar"/>
      </fileset>
      <fileset dir="${build.resources}">
        <include name="META-INF/ra.xml"/>
      </fileset>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- deploys the rar and example ConnectionFactoryLoader to              -->
  <!-- (my location of) JBoss                                              -->
  <!-- =================================================================== -->
  <target name="deploy-rar" depends="rar">
    <delete file="${jboss.base.dir}/deploy/firebird-service.xml"/>
    <delete file="${jboss.base.dir}/deploy/firebirdsql.rar"/>
    <!--sleep seconds="2"/coming with ant 1.4.1-->
    <copy todir="${jboss.base.dir}/deploy" file="${dist.dir}/firebirdsql.rar"/>
    <copy todir="${jboss.base.dir}/deploy" file="${build.dir}/firebird-service.xml"/>
  </target>


  <!-- =================================================================== -->
  <!-- runs the junit tests                                                -->
  <!-- =================================================================== -->

  <target name="all-tests" depends="jars">
    <!-- Override JUnit defaults -->

    <mkdir dir="${test.db.dir}"/>
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
	   printsummary="${junit.printsummary}" 
	   haltonerror="${junit.haltonerror}" 
	   haltonfailure="${junit.haltonfailure}" 
	   fork="${junit.fork}"
	   timeout="${junit.timeout}"
	   jvm="${junit.jvm}">

      <jvmarg value="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="log4j.properties" file="${build.resources}/log4j.properties"/>
      <sysproperty key="test.db.dir" value="${test.db.dir}"/>

      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <path refid="javac.classpath"/>
      </classpath>

      <formatter type="${junit.formatter.type}"
		 usefile="${junit.formatter.usefile}"/>

      <batchtest todir="${build.reports}"
		 haltonerror="${junit.batchtest.haltonerror}" 
		 haltonfailure="${junit.batchtest.haltonfailure}" 
		 fork="${junit.batchtest.fork}">

        <fileset dir="${build.classes}">
          <include name="**/Test*.class"/>
          <exclude name="**/TestAll.class"/>
          <exclude name="**/TestXABase*.class"/>
          <exclude name="**/TestConst.class"/>

        </fileset>
      </batchtest>
    </junit>
  </target>

  <!--
     | Run a single testcase by specifing the part of the test name after Test before the .class 
     | of the unit test using the test property, -Dtest=Gds one-test
     | Here you specify the testcase class, not the directory
   -->

  <target name="one-test" depends="jars" if="test"
	  description="Execute a single test.">
    <mkdir dir="${test.db.dir}"/>
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
	   printsummary="${junit.printsummary}" 
	   haltonerror="${junit.haltonerror}" 
	   haltonfailure="${junit.haltonfailure}" 
	   fork="${junit.fork}"
	   timeout="${junit.timeout}"
	   jvm="${junit.jvm}">

      <jvmarg value="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="log4j.properties" file="${build.resources}/log4j.properties"/>
      <sysproperty key="test.db.dir" value="${test.db.dir}"/>


      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <path refid="javac.classpath"/>
      </classpath>

      <formatter type="${junit.formatter.type}"
		 usefile="${junit.formatter.usefile}"/>

      <batchtest todir="${build.reports}"
		 haltonerror="${junit.batchtest.haltonerror}" 
		 haltonfailure="${junit.batchtest.haltonfailure}" 
		 fork="${junit.batchtest.fork}">

        <fileset dir="${build.classes}">
          <include name="org/firebirdsql/*/Test${test}*.class"/>
        </fileset>
      </batchtest>
    </junit>
  </target>



  <!--maybe later target name="tests-report-html" depends="tests-standard-unit">
    <mkdir dir="${build.reports}/html"/>

    <junitreport todir="${build.reports}">
      <fileset dir="${build.reports}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" 
              todir="${build.reports}/html"
              styledir="${build.stylesheets}"
      />
    </junitreport>
  </target-->

  <!-- =================================================================== -->
  <!-- Creates the API documentation                                       -->
  <!-- =================================================================== -->
  <target name="javadocs">
    <mkdir dir="${build.docs}"/>
    <javadoc packagenames="${packages}"
             sourcepath="${src.dir}"
             destdir="${build.docs}"
             classpath="${classpath}"
             author="true"
             version="true"
             windowtitle="${Name} API"
             doctitle="${Name}"
             extdirs="${src.lib.dir}"
             bottom="Copyright &#169; 2001 David Jencks and other authors. All rights reserved."
    />
  </target>

  <!-- =================================================================== -->
  <!-- Creates the html documentation                                      -->
  <!-- =================================================================== -->
  <target name="docs">

    <!--echo message="Building html documentation. Please wait ..."/-->
<!--    <style  basedir="${src.docs.dir}"
             style="jboss.xsl"
             destdir="${build.docs.dir}"
             includes="jbossdocs.xml"
    />
    <move todir="${build.docs.dir}">
      <fileset dir="${src.dir}/build" includes="*.html"/>
    </move>
    <delete file="${build.docs.dir}/jbossdocs.html"/>-->

    <!-- Stylesheets, images, and static HTML -->
 <!--   <copy todir="${build.docs.dir}">
       <fileset dir="${src.dir}/docs" excludes="*.xml,*.xsl,**/docbook/**,**/docbookx/**"/>
     </copy>
     -->
  </target>

  <!-- =================================================================== -->
  <!-- Creates the distribution                                            -->
  <!-- =================================================================== -->
  <target name="dist" depends="jar-ra,javadocs">
     <mkdir dir="${dist.dir}/docs"/>
     <mkdir dir="${dist.dir}/docs/api"/>
     <!--copy todir="${dist.dir}/docs">
        <fileset dir="${docs.dir}"/>
     </copy-->
     <copy todir="${dist.dir}/docs/api">
        <fileset dir="${build.javadocs.dir}"/>
     </copy>

     <mkdir dir="${dist.dir}/src"/>
     <copy todir="${dist.dir}/src">
        <fileset dir="${src.dir}">
           <exclude name="**/*.jar"/>
        </fileset>
     </copy>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the source files with ZIP                                  -->
  <!-- =================================================================== -->
  <target name="src-zip">
    <zip zipfile="${Name}-src-${version}.zip" basedir="../.." includes="clients/java/**" excludes="clients/java/**.zip"/>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the distribution with ZIP                                  -->
  <!-- =================================================================== -->
  <target name="dist-zip" depends="dist">
    <zip zipfile="${Name}-${version}.zip" basedir="${dist.dir}" includes="src/**"/>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the distribution with TAR-GZIP                             -->
  <!-- =================================================================== -->
  <target name="dist-tgz" depends="dist">
    <tar tarfile="${Name}-${version}.tar" basedir="${dist.dir}" includes="src/**"/>
    <gzip zipfile="${Name}-${version}.tar.gz" src="${Name}-${version}.tar"/>
  </target>

  <!-- =================================================================== -->
  <!-- Cleans up generated stuff                                           -->
  <!-- =================================================================== -->
  <target name="clean">
    <delete dir="${module.output}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Total cleanup                                                       -->
  <!-- =================================================================== -->
  <target name="total-clean" depends="clean">
    <delete file="${Name}-${version}.zip"/>
    <delete file="${Name}-${version}.tar"/>
    <delete file="${Name}-${version}.tar.gz"/>
  </target>
</project>






