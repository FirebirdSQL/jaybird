<?xml version="1.0"?>

<!-- ======================================================================= -->
<!-- JDBC-JCA Driver for Firebird build file                                -->
<!-- ======================================================================= -->

<!--NOTE IMPORTANT  to run the junit tests you need to create a directory dbsrc
 next to db and create an empty dialect 3 database in it called fbmctest.gdb.
Sorry, I haven'tbeen able to create a dialect 3 db dynamically yet. -->

<project name="FirebirdSQL" default="rar" basedir="../..">

    <property name="Name" value="FirebirdSQL"/>
    <property name="name" value="firebirdsql"/>
    <property name="version" value="0.0"/>

    <property name="lib.dir" value="${basedir}/lib"/>
    <property name="src.dir" value="${basedir}/src"/>
    <property name="src.docs.dir" value="${src.dir}/docs"/>

    <property name="src.resources.dir" value="${src.dir}/resources"/>
    <property name="src.lib.dir" value="${src.dir}/lib"/>
    <property name="build.dir" value="${basedir}/build"/>
    <property name="build.bin.dir" value="${build.dir}/bin"/>
    <property name="build.lib.dir" value="${build.dir}/lib"/>
    <property name="build.classes" value="${build.dir}/classes"/>
    <property name="build.docs.dir" value="${build.dir}/docs"/>
    <property name="build.javadocs.dir" value="${build.dir}/docs/api"/>
    <property name="build.jar-ra.dir" value="${build.dir}/jar"/>
    <property name="dist.dir" value="dist"/>
    <property name="external.dir" value="${dist.dir}/external"/>
    <property name="db.dir" value="${basedir}/db"/>
    <property name="dbsrc.dir" value="${basedir}/dbsrc"/>
<!--you will presumably need to change this if you want to use it.-->
    <property name="jboss.base.dir" value="/usr/java/jboss/co4/jboss-all/build/output/jboss-3.0.0alpha"/>



    <property name="classpath" value="${build.classes};${src.lib.dir}/jta-spec1_0_1.jar;${src.lib.dir}/connector.jar;${src.lib.dir}/jdbc-3_0-pfd2-classes.zip;${src.lib.dir}/jaas.jar"/>
    <property name="packages" value="org.firebirdsql.*"/>

    <property name="build.compiler" value="classic"/>

    <!--available property="jdk1.3+" classname="java.lang.StrictMath" /-->

    <path id="javac.classpath">
      <pathelement location="${build.classes}"/>
      <pathelement location="${src.lib.dir}/jta-spec1_0_1.jar"/>
      <pathelement location="${src.lib.dir}/connector.jar"/>
      <pathelement location="${src.lib.dir}/jdbc-3_0-pfd2-classes.zip"/>
      <pathelement location="${src.lib.dir}/jaas.jar"/>
      <pathelement location="${src.lib.dir}/jmxri.jar"/>
      <pathelement location="${lib.dir}/junit.jar"/>
    </path>


  <!-- =================================================================== -->
  <!-- Fix cr-lf                                                           -->
  <!-- =================================================================== -->
  <target name="pretty">
    <fixcrlf srcDir="${src.dir}"
       includes="**/*.java,**/*.xml,**/*.sh"
       cr="remove"
       tab="remove"
       tablength="4"
       eof="remove"/>
  </target>

  <!-- =================================================================== -->
  <!-- Prepares the build directory                                        -->
  <!-- =================================================================== -->
  <target name="prepare">
    <mkdir dir="${build.dir}"/>
    <mkdir dir="${dist.dir}"/>
    <mkdir dir="${build.docs.dir}"/>
    <mkdir dir="${basedir}/db"/>
  </target>

  <!-- =================================================================== -->
  <!-- Compiles the source code                                            -->
  <!-- =================================================================== -->
  <target name="compile" depends="prepare">
    <mkdir dir="${build.classes}"/>
    <depend srcDir="${src.dir}"
           destDir="${build.classes}"
           cache="${build.classes}"/>

    <javac srcdir="${src.dir}"
           destdir="${build.classes}"
           debug="off"
           deprecation="off"
           optimize="on"
           includes="org/**"
           excludes="**/temp*"
    >
      <classpath refid="javac.classpath"/>
    </javac>
    <copy todir="${build.classes}">
        <fileset dir="${src.dir}" includes="**/*.properties"/>
    </copy>

    <!--mkdir dir="${build.dir}/META-INF"/-->
    <copy todir="${build.dir}/META-INF">
        <fileset dir="${src.resources.dir}" includes="**/ra.xml"/>
    </copy>

    <copy todir="${build.dir}">
        <fileset dir="${src.resources.dir}" includes="**/firebird-service.xml"/>
    </copy>

  </target>
  <!-- =================================================================== -->
  <!-- Creates the jar archives                                            -->
  <!-- =================================================================== -->
  <target name="jar-ra" depends="compile">

    <mkdir dir="${build.jar-ra.dir}"/>
    <jar jarfile="${build.jar-ra.dir}/firebirdsql.jar"
         basedir="${build.classes}"
         includes="org/firebirdsql/**"
         excludes="**/Test*.java"
    />
  </target>


  <!-- =================================================================== -->
  <!-- Creates the jmx-jar archives                                            -->
  <!-- =================================================================== -->
  <target name="jmx.jar" depends="compile">

    <jar jarfile="${dist.dir}/firebirdjmx.jar"
         basedir="${build.classes}"
         includes="**/gds/**, **/jgds/**, **/management/**, **/META-INF/**"
         excludes="**/test/**"
    />
    <copy todir="/usr/java/jboss/dev/jboss/dist/lib/ext">
        <fileset dir="${dist.dir}" includes="firebirdjmx.jar"/>
    </copy>
  </target>



  <!-- =================================================================== -->
  <!-- Creates the rar archives                                            -->
  <!-- =================================================================== -->
  <target name="rar" depends="jar-ra">
    <mkdir dir="${build.jar-ra.dir}/META-INF"/>
    <copy todir="${build.jar-ra.dir}/META-INF">
        <fileset dir="${src.resources.dir}"/>
    </copy>

    <jar jarfile="${dist.dir}/firebirdsql.rar"
         basedir="${build.jar-ra.dir}"
         includes="firebirdsql.jar,META-INF/ra.xml"
    />
  </target>

  <!-- =================================================================== -->
  <!-- deploys the rar and example ConnectionFactoryLoader to              -->
  <!-- (my location of) JBoss                                              -->
  <!-- =================================================================== -->
  <target name="deploy-rar" depends="rar">
    <delete file="${jboss.base.dir}/deploy/firebird-service.xml"/>
    <delete file="${jboss.base.dir}/deploy/firebirdsql.rar"/>
    <!--sleep seconds="2"/coming with ant 1.4.1-->
    <copy todir="${jboss.base.dir}/deploy" file="${dist.dir}/firebirdsql.rar"/>
    <copy todir="${jboss.base.dir}/deploy" file="${build.dir}/firebird-service.xml"/>
  </target>


  <!-- =================================================================== -->
  <!-- runs the junit tests                                                -->
  <!-- =================================================================== -->
  <target name="junit" depends="jmx.jar">
    <delete file="${db.dir}/fbmctest.gdb"/>
    <copy todir="${db.dir}">
        <fileset dir="${dbsrc.dir}"/>
    </copy>
    <junit>
      <classpath>
         <path refid="javac.classpath"/>
         <pathelement location="${build.classes}"/>
      </classpath>
      <formatter type="plain" usefile="false"/>
      <!--test name="org.firebirdsql.jca.TestFBResultSet"/-->
      <test name="org.firebirdsql.jca.TestFBDatabaseMetaData"/>
    </junit>
  </target>

  <target name="junit1" depends="jmx.jar">
    <delete file="${db.dir}/fbmctest.gdb"/>
    <copy todir="${db.dir}">
        <fileset dir="${dbsrc.dir}"/>
    </copy>
    <junit>
      <classpath>
         <path refid="javac.classpath"/>
         <pathelement location="${build.classes}"/>
      </classpath>
      <formatter type="plain" usefile="false"/>
      <!--test name="org.firebirdsql.management.TestFBManager"/-->
      <test name="org.firebirdsql.jca.TestAll"/>
      <test name="org.firebirdsql.jdbc.TestAll"/>
      <!--test name="org.firebirdsql.jgds.TestGds"/>
      <test name="org.firebirdsql.jca.TestFBManagedConnectionFactory"/>
      <test name="org.firebirdsql.jca.TestFBXAResource"/>
      <test name="org.firebirdsql.jca.TestFBConnection"/>
      <test name="org.firebirdsql.jca.TestFBStandAloneConnectionManager"/>
      <test name="org.firebirdsql.jca.TestFBResultSet"/>
      <test name="org.firebirdsql.jca.TestFBBlob"/>
      <test name="org.firebirdsql.jca.TestFBDatabaseMetaData"/-->
    </junit>
  </target>

  <target name="tests-standard-unit" depends="jmx.jar">
    <!-- Override JUnit defaults -->
    <!-- Setup the module environment. -->
    <property name="module.root" value="${basedir}"/>

    <property file="${module.root}/local.properties"/>
    <property name="module.source" value="${module.root}/src"/>
    <property name="module.output" value="${module.root}/output"/>
    <property name="module.tools" value="${module.root}/tools"/>
    <property name="module.thirdparty" value="${module.root}/thirdparty"/>


    <property name="junit.timeout" value="600000"/> <!-- 10 minutes -->
    <property name="junit.batchtest.todir" value="${build.reports}"/>
    <property name="junit.jvm.options" value="-Ddummy"/>

    <property name="build.stylesheets" value="${module.source}/stylesheets"/>
    <property name="build.reports" value="${module.output}/reports"/>
    <property name="build.testlog" value="${module.output}/log"/>

    <property name="junit.formatter.type" value="xml"/>
    <property name="junit.formatter.usefile" value="true"/>


    <delete file="${db.dir}/fbmctest.gdb"/>
    <copy todir="${db.dir}">
        <fileset dir="${dbsrc.dir}"/>
    </copy>
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
	   printsummary="${junit.printsummary}" 
	   haltonerror="${junit.haltonerror}" 
	   haltonfailure="${junit.haltonfailure}" 
	   fork="${junit.fork}"
	   timeout="${junit.timeout}"
	   jvm="${junit.jvm}">

      <jvmarg value="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="log4j.properties" file="${build.resources}/log4j.properties"/>

      <classpath>
        <pathelement location="${build.classes}"/>
        <!--pathelement location="${build.resources}"/-->
        <path refid="javac.classpath"/>
      </classpath>

      <formatter type="${junit.formatter.type}"
		 usefile="${junit.formatter.usefile}"/>

      <batchtest todir="${build.reports}"
		 haltonerror="${junit.batchtest.haltonerror}" 
		 haltonfailure="${junit.batchtest.haltonfailure}" 
		 fork="${junit.batchtest.fork}">

        <fileset dir="${build.classes}">
          <include name="**/Test*.class"/>
          <exclude name="**/TestAll.class"/>
          <exclude name="**/TestXABase*.class"/>
          <exclude name="**/TestConst.class"/>

        </fileset>
      </batchtest>
    </junit>
  </target>

  <!--maybe later target name="tests-report-html" depends="tests-standard-unit">
    <mkdir dir="${build.reports}/html"/>

    <junitreport todir="${build.reports}">
      <fileset dir="${build.reports}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" 
              todir="${build.reports}/html"
              styledir="${build.stylesheets}"
      />
    </junitreport>
  </target-->

  <!-- =================================================================== -->
  <!-- Creates the API documentation                                       -->
  <!-- =================================================================== -->
  <target name="javadocs" depends="prepare">
    <mkdir dir="${build.javadocs.dir}"/>
    <javadoc packagenames="${packages}"
             sourcepath="${src.dir}"
             destdir="${build.javadocs.dir}"
             classpath="${classpath}"
             author="true"
             version="true"
             windowtitle="${Name} API"
             doctitle="${Name}"
             extdirs="${src.lib.dir}"
             bottom="Copyright &#169; 2001 David Jencks and other authors. All rights reserved."
    />
  </target>

  <!-- =================================================================== -->
  <!-- Creates the html documentation                                      -->
  <!-- =================================================================== -->
  <target name="docs" depends="prepare">

    <echo message="Sorry, you must copy the xml file into the manual/src/docs"/>
    <echo message="directory, add an external entity to jbossdocs.xml for howtorules,"/>
    <echo message="and compile it as part of the jboss documentation."/>
    <!--echo message="Building html documentation. Please wait ..."/-->
<!--    <style  basedir="${src.docs.dir}"
             style="jboss.xsl"
             destdir="${build.docs.dir}"
             includes="jbossdocs.xml"
    />
    <move todir="${build.docs.dir}">
      <fileset dir="${src.dir}/build" includes="*.html"/>
    </move>
    <delete file="${build.docs.dir}/jbossdocs.html"/>-->

    <!-- Stylesheets, images, and static HTML -->
 <!--   <copy todir="${build.docs.dir}">
       <fileset dir="${src.dir}/docs" excludes="*.xml,*.xsl,**/docbook/**,**/docbookx/**"/>
     </copy>
     -->
  </target>

  <!-- =================================================================== -->
  <!-- Creates the distribution                                            -->
  <!-- =================================================================== -->
  <target name="dist" depends="jar-ra,javadocs">
     <mkdir dir="${dist.dir}/docs"/>
     <mkdir dir="${dist.dir}/docs/api"/>
     <!--copy todir="${dist.dir}/docs">
        <fileset dir="${docs.dir}"/>
     </copy-->
     <copy todir="${dist.dir}/docs/api">
        <fileset dir="${build.javadocs.dir}"/>
     </copy>

     <mkdir dir="${dist.dir}/src"/>
     <copy todir="${dist.dir}/src">
        <fileset dir="${src.dir}">
           <exclude name="**/*.jar"/>
        </fileset>
     </copy>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the source files with ZIP                                  -->
  <!-- =================================================================== -->
  <target name="src-zip">
    <zip zipfile="${Name}-src-${version}.zip" basedir="../.." includes="clients/java/**" excludes="clients/java/**.zip"/>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the distribution with ZIP                                  -->
  <!-- =================================================================== -->
  <target name="dist-zip" depends="dist">
    <zip zipfile="${Name}-${version}.zip" basedir="${dist.dir}" includes="src/**"/>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the distribution with TAR-GZIP                             -->
  <!-- =================================================================== -->
  <target name="dist-tgz" depends="dist">
    <tar tarfile="${Name}-${version}.tar" basedir="${dist.dir}" includes="src/**"/>
    <gzip zipfile="${Name}-${version}.tar.gz" src="${Name}-${version}.tar"/>
  </target>

  <!-- =================================================================== -->
  <!-- Cleans up generated stuff                                           -->
  <!-- =================================================================== -->
  <target name="clean">
    <delete dir="${build.dir}"/>
    <delete dir="${dist.dir}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Total cleanup                                                       -->
  <!-- =================================================================== -->
  <target name="total-clean" depends="clean">
    <delete file="${Name}-${version}.zip"/>
    <delete file="${Name}-${version}.tar"/>
    <delete file="${Name}-${version}.tar.gz"/>
  </target>
</project>






