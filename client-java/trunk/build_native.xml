<?xml version="1.0"?>
<!--
	JDBC-JCA Driver for Firebird build file for native code



	This build file will build the code from:

	src/native/jaygds

	into a shared library named 'jaybird' in:

	output/native

  This file requires that either the environment variable JDK_HOME or the property java_home is set.



	Current Supported Platforms:

	Platform		    Compiler/Linker

	Windows         MSVC 6
	Solaris         GCC
	Linux           GCC

	These are platforms that this build file should in theory build on correctly. Not all these platforms have been tested.
-->
<project name="FirebirdSQL_native" default="compile" basedir=".">

    <taskdef resource="cpptasks.tasks"/>
    <typedef resource="cpptasks.types"/>

    <!--
    -->
    <target name="init">
        <!-- Setup the build timestamp & build identifer properties -->
        <tstamp>
            <format property="build.number" pattern="yyyyMMddHHmm"/>
            <format property="YEAR" pattern="yyyy"/>
        </tstamp>

        <property environment="env"/>

        <!--  -->
        <property name="module.root" value="${basedir}"/>
        <property name="module.source" value="${module.root}/src"/>
        <property name="module.output" value="${module.root}/output"/>

        <!--  -->
        <property name="build.native" value="${module.output}/native"/>
        <property name="build.native.output" value="${build.native}"/>

        <!--  -->
        <property name="source.native" value="${module.source}/native/jaygds/source"/>

        <mkdir dir="${build.native.output}"/>


        <!--
        Set 'java_home' property to value of environment variable JAVA_HOME if java_home property is not already set.
        -->
        <condition property="java_home" value="${env.JAVA_HOME}">
        <and>
            <isset property="env.JAVA_HOME"/>
            <not>
                <isset property="java_home"/>
            </not>
        </and>
        </condition>

    </target>

    <!--
    There are three main pieces of infomation we need about the platform. This target extracts that infomation.

    First we need to know if this platform is windows in which case we use msvc otherwise all other platforms
    will use gcc. To do this we set the property:

    buildon-windows

    if the platform is windows otherwise we leave the property unset.


    Next we need to know the name of the directory of the platform specific header files in the JDK. This name is placed
    into:

    jdks_platform_headers

    Finally we need to know the name of the directory containg jaybirds platform specfic headers. This name is placed
    into:

    jaybirds_platform_headers
    -->
    <target name="set_platform_properties" depends="init">


        <!-- set 'buildon-windows' - this should be all we ever need here  -->
        <condition property="buildon-windows">
            <os family="windows"/>
        </condition>
         <condition property="buildon-unix">
            <not>
                <isset property="buildon-windows"/>
            </not>
        </condition>


        <!-- set 'jaybirds_platform_headers' - this should be fairly easy -->

        <condition property="jaybirds_platform_headers" value="win32">
            <isset property="buildon-windows"/>
        </condition>

        <condition property="jaybirds_platform_headers" value="generic_unix">
            <not>
                <isset property="buildon-windows"/>
            </not>
        </condition>


        <!-- set 'jdks_platform_headers' -->

        <condition property="jdks_platform_headers" value="win32">
            <isset property="buildon-windows"/>
        </condition>

        <condition property="jdks_platform_headers" value="solaris">
            <os name="SunOS"/>
        </condition>

        <condition property="jdks_platform_headers" value="linux">
            <os name="linux"/>
        </condition>

    </target>


    <!--
	-->
    <target name="compile" depends="init,set_platform_properties">

        <cc debug="false"
            link="shared"
            objdir="${build.native.output}"
            outfile="${build.native.output}/jaybird"
            multithreaded="true"
            exceptions="true">

            <!-- jaybird include search paths -->
            <includepath location="${source.native}"/>
            <includepath location="${source.native}/${jaybirds_platform_headers}"/>
            <includepath location="${source.native}/external"/>

            <!-- jdk include search paths  -->
            <includepath location="${java_home}/include"/>
            <includepath location="${java_home}/include/${jdks_platform_headers}"/>

            <!-- jaybird files to be compiles -->
            <fileset dir="${source.native}">
                <include name="*.cpp"/>
                <include name="${jaybirds_platform_headers}/platform.cpp"/>
            </fileset>

            <!--
            Compilers and Linkers

            msvc is used on windows and gcc on all other platforms.

            Only release builds are created.
                    -->

            <compiler id="gcc" name="gcc" if="buildon-unix">

                <defineset>
                    <define name="JAVA_GDS_EXPORTS"/>
                </defineset>
            </compiler>

            <compiler id="msvc" name="msvc" if="buildon-windows">
                <!--  target Pentium Pro   -->
                <compilerarg value="/G6"/>
                <!--  display many warnings   -->
                <compilerarg value="/W3"/>
                <!--  maximize speed     -->
                <compilerarg value="/O2"/>
                <!--  auto-inlining    -->
                <compilerarg value="/Ob2"/>
                <!--  mulithread dll crt    -->
                <compilerarg value="/MD"/>

                <defineset>
                    <define name="WIN32"/>
                    <define name="NDEBUG"/>
                    <define name="_WINDOWS"/>
                    <define name="_MBCS"/>
                    <define name="_USRDLL"/>
                    <define name="JAVA_GDS_EXPORTS"/>
                </defineset>

            </compiler>

            <linker name="gcc" if="buildon-unix">
                <linkerarg value="-ldl"/>
                <linkerarg value="-lc"/>
            </linker>

            <linker name="msvc" if="buildon-windows">
                <syslibset libs="kernel32,user32"/>
            </linker>
        </cc>

        <delete>
            <fileset dir="${build.native.output}" includes="*.obj"/>
            <fileset dir="${build.native.output}" includes="*.o"/>
            <fileset dir="${build.native.output}" includes="*.exp"/>
            <fileset dir="${build.native.output}" includes="*.lib"/>
            <fileset dir="${build.native.output}" includes="*.xml"/>
        </delete>

    </target>

</project>